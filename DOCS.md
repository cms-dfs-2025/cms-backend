# Документация проекта

## Запуск

Для работы требуется установить docker и docker-compose.

Перед запуском нужно создать файл `.env` и определить в нем все необходимые
переменные (см. [.env](#env)). docker-compose в первую очередь использует
переменные среды, определенные для самого процесса, а не в файле `.env`,
поэтому для работы лучше открыть свежий терминал.

Для запуска достаточно использовать `docker-compose up` или
`docker-compose up -d` для запуска в фоновом режиме.

## Архитектура

База данных состоит из docker-контейнеров, управляемых с помощью
`docker-compose` (см. файл `docker-compose.yaml`).

### Контейнер database

Контейнер содержит postgres сервер, открытый к подключению извне сети
контейнеров на порте `POSTGRES_CONNECT_PORT`. Пользователь, пароль и база
данных определены в переменных среды `POSTGRES_USER`, `POSTGRES_PASSWORD`,
`POSTGRES_DBNAME` соответственно. Подключиться напрямую к базе данных из
машины, на которой запущен контейнер и установлен `postgres` можно командой
```sh
psql -h localhost -p $POSTGRES_CONNECT_PORT -U $POSTGRES_USER
```
, введя пароль и подключившись к соответствующей базе данных.

Контейнер хранит данные в локальной папке `volumes/db-data`. Если папки нет,
он ее создает и запускает скрипт `db-init/init.sql` для инициализации базы
данных. База данных не хранит файлы статей, этим занимается server.

**Схему бд** можно увидеть в `db-init/init.sql`.

**Операции с пользователями.** Некоторые операции можно сделать только через
подключение к базе данных напрямую. Чтобы предоставить пользователю права
администратора нужно ввести запрос типа
```sql
UPDATE users SET is_admin = true WHERE handle='AzureDiamond';
```

### Контейнер server

Контейнер содержит golang http сервер, открытый к подключению извне контейнера
на порте `SERVER_PORT`. Исходный код сервера находится в папке `go-src`,
Dockerfile контейнера - `Dockerfile-server`. Адреса возможных запросов к
серверу задокументированы в [ENDPOINTS.md](./ENDPOINTS.md).

Контейнер хранит данные (файлы статей) в `volumes/documents`.

Во время разработки (запуска через `go run .`) используются только переменные
среды из `.env`. В контейнере некоторые переменные среды переписываются (см.
`docker-compose.yaml` и `Dockerfile-server`).

## .env

Перед запуском проекта нужно создать файл `.env`, в котором нужно определить
переменные
```bash
# Пароль для подключения к sql базе данных
POSTGRES_PASSWORD=

# Пользователь для подключения к sql базе данных
POSTGRES_USER=

# Название sql базы данных
POSTGRES_DBNAME=

# Хост и порт для подключения к sql базе данных извне контейнеров
POSTGRES_HOST=localhost
POSTGRES_CONNECT_PORT=

# Порт для подключения к серверу извне контейнеров
SERVER_PORT=

# Путь к файлам фронтенда (папка dist), используемый во время разработки
FRONT_FILES=

# Путь к файлам постов
DOCS_PATH=
```
Перед запуском пустым переменным нужно присвоить некоторые значения.
